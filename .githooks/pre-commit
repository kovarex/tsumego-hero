#!/bin/bash
#
# Pre-commit hook to verify code quality before commit
# This prevents CI failures by catching issues locally
#
# Skip with: git commit --no-verify (or git commit -n)
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üîç Running pre-commit checks...${NC}"

# Check if this is a WIP commit (skip quality checks)
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
    if [[ "$COMMIT_MSG" =~ ^(WIP:|fixup!|squash!) ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  WIP commit detected - skipping code quality checks${NC}"
        echo -e "${YELLOW}   (Only checking executable bits)${NC}"
        SKIP_QUALITY=true
    fi
fi

# ===== 1. EXECUTABLE BIT CHECK (always run) =====
echo -e "\n${GREEN}üìÅ Checking shell script permissions...${NC}"

EXECUTABLES=(
    "bin/cake"
    "cs-modified.sh"
    "deploy.sh"
    "scripts/test.sh"
    "setup/nfs-php-target-setup.sh"
    "setup/php-install.sh"
)

PERM_ERRORS=0

for file in "${EXECUTABLES[@]}"; do
    if [ -f "$file" ]; then
        MODE=$(git ls-files -s "$file" 2>/dev/null | cut -d' ' -f1)
        
        if [ "$MODE" = "100644" ]; then
            echo -e "${RED}‚ùå $file lost executable bit!${NC}"
            echo -e "   Run: git update-index --chmod=+x $file"
            PERM_ERRORS=$((PERM_ERRORS + 1))
        fi
    fi
done

if [ $PERM_ERRORS -gt 0 ]; then
    echo -e "\n${RED}‚ùå Commit rejected: $PERM_ERRORS file(s) missing executable bit${NC}"
    echo -e "   Fix with: git update-index --chmod=+x <file>"
    echo -e "   Or edit shell scripts via WSL Remote to preserve permissions"
    exit 1
fi

echo -e "${GREEN}‚úÖ Shell script permissions OK${NC}"

# Skip quality checks for WIP commits
if [ "$SKIP_QUALITY" = true ]; then
    echo -e "\n${GREEN}‚úÖ Pre-commit checks passed (WIP mode)${NC}"
    exit 0
fi

# ===== 2. PHP CS FIXER (auto-fix) =====
echo -e "\n${GREEN}üîß Running PHP CS Fixer on staged files...${NC}"

# Get staged PHP files
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)

if [ -n "$STAGED_PHP_FILES" ]; then
    # Count files to determine if --path-mode is needed
    FILE_COUNT=$(echo "$STAGED_PHP_FILES" | wc -l)
    
    # Run PHP CS Fixer on staged files only
    # Try ddev first (for WSL/Linux environments), fall back to direct execution
    if command -v ddev &> /dev/null && ddev describe &> /dev/null 2>&1; then
        if [ "$FILE_COUNT" -gt 1 ]; then
            ddev exec vendor/bin/php-cs-fixer fix $STAGED_PHP_FILES --path-mode=intersection --quiet
        else
            ddev exec vendor/bin/php-cs-fixer fix $STAGED_PHP_FILES --quiet
        fi
    elif [ -f "./vendor/bin/php-cs-fixer" ]; then
        if [ "$FILE_COUNT" -gt 1 ]; then
            ./vendor/bin/php-cs-fixer fix $STAGED_PHP_FILES --path-mode=intersection --quiet
        else
            ./vendor/bin/php-cs-fixer fix $STAGED_PHP_FILES --quiet
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  php-cs-fixer not found, skipping code style check${NC}"
        echo -e "${YELLOW}   (Run: composer install)${NC}"
    fi
    
    # Re-add files that were fixed
    for file in $STAGED_PHP_FILES; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done
    
    echo -e "${GREEN}‚úÖ PHP CS Fixer completed${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  No PHP files staged${NC}"
fi

# ===== 3. PHPSTAN (analyze) =====
echo -e "\n${GREEN}üîç Running PHPStan on staged files...${NC}"

if [ -n "$STAGED_PHP_FILES" ]; then
    # Run PHPStan on staged files
    # Try ddev first (for WSL/Linux environments), fall back to direct execution
    PHPSTAN_ERRORS=0
    
    if command -v ddev &> /dev/null && ddev describe &> /dev/null 2>&1; then
        if ! ddev exec vendor/bin/phpstan analyse $STAGED_PHP_FILES --no-progress 2>&1; then
            PHPSTAN_ERRORS=1
        fi
    elif [ -f "./vendor/bin/phpstan" ]; then
        if ! ./vendor/bin/phpstan analyse $STAGED_PHP_FILES --no-progress 2>&1; then
            PHPSTAN_ERRORS=1
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  phpstan not found, skipping static analysis${NC}"
        echo -e "${YELLOW}   (Run: composer install)${NC}"
    fi
    
    if [ $PHPSTAN_ERRORS -gt 0 ]; then
        echo -e "\n${RED}‚ùå PHPStan found errors!${NC}"
        echo -e "${YELLOW}   Fix errors or skip with: git commit --no-verify${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}‚úÖ PHPStan passed${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  No PHP files staged${NC}"
fi

# ===== ALL CHECKS PASSED =====
echo -e "\n${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
